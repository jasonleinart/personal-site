---
/**
 * Case Study Detail Page
 * 
 * Dynamic route that displays a comprehensive project case study following a structured
 * narrative format. Presents the complete story of a project from problem identification
 * through to measurable impact and learnings.
 * 
 * Narrative Structure (enforced order):
 * 1. Overview - High-level project summary
 * 2. Problem - Challenge being addressed
 * 3. Constraints - Limitations and boundaries
 * 4. Approach - Solution strategy
 * 5. Key Decisions - Technical choices with reasoning and alternatives
 * 6. Tech Stack - Technologies used
 * 7. Result & Impact - Quantitative metrics and qualitative outcomes
 * 8. Learnings - Insights and takeaways
 * 
 * Features:
 * - Static path generation for all project entries
 * - Structured case study presentation
 * - Impact metrics grid (when available)
 * - Reading time calculation
 * - Structured data for SEO
 * - Optional additional markdown content
 * - Scroll-to-top functionality
 * - Related content navigation
 * - Back navigation to projects list
 * 
 * Route: /projects/[slug]
 * 
 * @page
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import StructuredData from '../../components/StructuredData.astro';
import ScrollToTop from '../../components/ScrollToTop.astro';
import BackLink from '../../components/BackLink.astro';
import RelatedContent from '../../components/RelatedContent.astro';
import ImpactMetrics from '../../components/ImpactMetrics.astro';
import TableOfContents from '../../components/TableOfContents.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { calculateReadingTime, formatReadingTime } from '../../utils/readingTime';

/**
 * Generates static paths for all project entries
 * 
 * Queries the projects content collection and creates a route for each entry
 * using the entry ID as the slug parameter.
 * 
 * @returns Array of path objects with params
 */
export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.id },
  }));
}

const { slug } = Astro.params;

/**
 * Retrieves the specific project entry by slug
 * 
 * Redirects to 404 if the project is not found.
 */
const project = await getEntry('projects', slug!);

if (!project) {
  return Astro.redirect('/404');
}

// Render the content (v6-compatible method)
const { Content, headings } = await render(project);

const {
  title,
  role,
  year,
  duration,
  teamSize,
  outcomeSummary,
  overview,
  problem,
  constraints,
  approach,
  keyDecisions,
  techStack,
  impact,
  learnings,
  relatedProjects,
  relatedDecisions,
  status,
  contentOnly,
  tldr,
} = project.data;

// Status display configuration
const statusConfig = {
  completed: { label: 'Completed', class: 'status--completed' },
  ongoing: { label: 'Ongoing', class: 'status--ongoing' },
  archived: { label: 'Archived', class: 'status--archived' },
};
const statusInfo = statusConfig[status || 'completed'];

/**
 * Calculates reading time from all case study content
 * 
 * Combines all text sections including overview, problem, approach, decisions,
 * impact, learnings, and optional markdown body to estimate total reading time.
 */
const allText = [
  overview,
  problem,
  approach,
  ...constraints,
  ...keyDecisions.map(d => `${d.decision} ${d.reasoning} ${d.alternatives?.join(' ') || ''}`),
  impact.qualitative,
  ...learnings,
  project.body || '',
].join(' ');
const readingTime = formatReadingTime(calculateReadingTime(allText));

/**
 * Combines frontmatter section headings with MDX content headings
 * for a complete table of contents
 */
const frontmatterHeadings = [
  { depth: 2, text: 'Overview', slug: 'overview' },
  { depth: 2, text: 'Problem', slug: 'problem' },
  { depth: 2, text: 'Constraints', slug: 'constraints' },
  { depth: 2, text: 'Approach', slug: 'approach' },
  { depth: 2, text: 'Key Decisions', slug: 'key-decisions' },
  { depth: 2, text: 'Tech Stack', slug: 'tech-stack' },
  { depth: 2, text: 'Result & Impact', slug: 'result-impact' },
  { depth: 2, text: 'Learnings', slug: 'learnings' },
];
const allHeadings = [...frontmatterHeadings, ...headings];
---

<BaseLayout>
  <SEO 
    slot="head"
    title={`${title} - Case Study`}
    description={outcomeSummary}
    type="article"
  />

  <StructuredData
    type="Project"
    data={{
      title,
      outcomeSummary,
      problem,
      impact: impact.qualitative,
      techStack,
      year,
    }}
  />

  <main class="case-study">
    <!-- Case Study Header -->
    <header class="case-study-header">
      <div class="header-badges">
        {status && status !== 'completed' && (
          <span class:list={['status-badge', statusInfo.class]}>
            {statusInfo.label}
          </span>
        )}
      </div>
      <h1>{title}</h1>
      <div class="case-study-meta">
        <span class="meta-item">{role}</span>
        <span class="meta-separator">·</span>
        <span class="meta-item">{year}</span>
        {duration && (
          <>
            <span class="meta-separator">·</span>
            <span class="meta-item">{duration}</span>
          </>
        )}
        {teamSize && (
          <>
            <span class="meta-separator">·</span>
            <span class="meta-item">{teamSize} {teamSize === 1 ? 'person' : 'people'}</span>
          </>
        )}
        <span class="meta-separator">·</span>
        <span class="meta-item">{readingTime}</span>
      </div>
      <p class="outcome-summary">{outcomeSummary}</p>
      {techStack && techStack.length > 0 && (
        <div class="tech-tags">
          {techStack.map((tech) => (
            <span class="tech-tag">{tech}</span>
          ))}
        </div>
      )}
    </header>

    <!-- TL;DR Summary (if provided) -->
    {tldr && (
      <div class="tldr">
        <span class="tldr-label">TL;DR</span>
        <p class="tldr-summary">{tldr.summary}</p>
        <ul class="tldr-points">
          {tldr.points.map((point) => (
            <li set:html={point} />
          ))}
        </ul>
      </div>
    )}

    <!-- Table of Contents (for MDX content when contentOnly) -->
    {contentOnly && <TableOfContents headings={headings} />}

    {!contentOnly && (
      <>
        <!-- Table of Contents -->
        <TableOfContents headings={allHeadings} />

        <!-- Overview Section -->
        <section class="case-study-section">
          <h2 id="overview">Overview</h2>
          <p>{overview}</p>
        </section>

        <!-- Problem Section -->
        <section class="case-study-section">
          <h2 id="problem">Problem</h2>
          <p>{problem}</p>
        </section>

        <!-- Constraints Section -->
        <section class="case-study-section">
          <h2 id="constraints">Constraints</h2>
          <ul class="constraints-list">
            {constraints.map((constraint) => (
              <li>{constraint}</li>
            ))}
          </ul>
        </section>

        <!-- Approach Section -->
        <section class="case-study-section">
          <h2 id="approach">Approach</h2>
          <p>{approach}</p>
        </section>

        <!-- Key Decisions Section -->
        <section class="case-study-section">
          <h2 id="key-decisions">Key Decisions</h2>
          <div class="decisions-list">
            {keyDecisions.map((decision) => (
              <div class="decision-item">
                <h3 class="decision-title">{decision.decision}</h3>
                <div class="decision-reasoning">
                  <strong>Reasoning:</strong>
                  <p>{decision.reasoning}</p>
                </div>
                {decision.alternatives && decision.alternatives.length > 0 && (
                  <div class="decision-alternatives">
                    <strong>Alternatives considered:</strong>
                    <ul>
                      {decision.alternatives.map((alt) => (
                        <li>{alt}</li>
                      ))}
                    </ul>
                  </div>
                )}
              </div>
            ))}
          </div>
        </section>

        <!-- Tech Stack Section -->
        <section class="case-study-section">
          <h2 id="tech-stack">Tech Stack</h2>
          <ul class="tech-stack-list">
            {techStack.map((tech) => (
              <li>{tech}</li>
            ))}
          </ul>
        </section>

        <!-- Result/Impact Section -->
        <section class="case-study-section">
          <h2 id="result-impact">Result & Impact</h2>

          {/* Display metrics with visualization */}
          {impact.metrics && impact.metrics.length > 0 && (
            <ImpactMetrics metrics={impact.metrics} />
          )}

          <p class="impact-qualitative">{impact.qualitative}</p>
        </section>

        <!-- Learnings Section -->
        <section class="case-study-section">
          <h2 id="learnings">Learnings</h2>
          <ul class="learnings-list">
            {learnings.map((learning) => (
              <li>{learning}</li>
            ))}
          </ul>
        </section>
      </>
    )}

    <!-- Additional MDX Content (if any) -->
    {Content && (
      <section class="case-study-content">
        <Content />
      </section>
    )}

    <!-- Related Content -->
    <RelatedContent 
      relatedProjects={relatedProjects} 
      relatedDecisions={relatedDecisions} 
    />

    <BackLink href="/projects" text="All projects" />
  </main>

  <ScrollToTop />

  <style>
    /* TL;DR section */
    .tldr {
      margin: 0 0 2rem;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(196, 101, 74, 0.1) 0%, rgba(196, 101, 74, 0.05) 100%);
      border: 1px solid rgba(196, 101, 74, 0.3);
      border-radius: 8px;
      position: relative;
      overflow: hidden;
    }

    .tldr::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--color-accent) 0%, rgba(196, 101, 74, 0.3) 100%);
    }

    .tldr-label {
      display: inline-block;
      font-size: 0.6875rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--color-accent);
      background: rgba(196, 101, 74, 0.15);
      padding: 0.25rem 0.625rem;
      border-radius: 3px;
      margin-bottom: 1rem;
    }

    .tldr-summary {
      font-size: 1rem;
      line-height: 1.65;
      color: var(--color-text);
      margin-bottom: 1rem;
    }

    .tldr-points {
      margin: 0;
      padding-left: 1.25rem;
      list-style: disc;
    }

    .tldr-points li {
      font-size: 0.9375rem;
      margin-bottom: 0.375rem;
      color: var(--color-text-secondary);
      line-height: 1.5;
    }

    .tldr-points li:last-child {
      margin-bottom: 0;
    }

    .tldr-points :global(strong) {
      color: var(--color-text);
    }

    .case-study {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1.5rem;
    }

    .case-study-header {
      margin-bottom: 3rem;
      padding-bottom: 2rem;
      border-bottom: 1px solid var(--color-border);
    }

    .header-badges {
      margin-bottom: 0.75rem;
    }

    .header-badges:empty {
      display: none;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      font-size: 0.6875rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 0.3rem 0.625rem;
      border-radius: 4px;
    }

    .status--ongoing {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .status--archived {
      background: rgba(115, 115, 115, 0.15);
      color: var(--color-text-muted);
    }

    .case-study-header h1 {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1.2;
    }

    .case-study-meta {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 0.9375rem;
      color: var(--color-text-secondary);
      margin-bottom: 1.5rem;
    }

    .meta-separator {
      opacity: 0.5;
    }

    .outcome-summary {
      font-size: 1.125rem;
      line-height: 1.6;
      color: var(--color-text-secondary);
    }

    .tech-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 1.25rem;
    }

    .tech-tag {
      font-size: 0.8125rem;
      padding: 0.25rem 0.75rem;
      background: rgba(74, 153, 97, 0.1);
      border: 1px solid var(--color-accent-secondary);
      border-radius: 4px;
      color: var(--color-accent-secondary);
    }

    .case-study-section {
      margin-bottom: 3rem;
    }

    .case-study-section h2 {
      font-size: 1.75rem;
      margin-bottom: 1.25rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .case-study-section p {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    .constraints-list,
    .tech-stack-list,
    .learnings-list {
      list-style: none;
      padding: 0;
    }

    .constraints-list li,
    .tech-stack-list li,
    .learnings-list li {
      font-size: 1.0625rem;
      line-height: 1.7;
      padding: 0.5rem 0;
      padding-left: 1.5rem;
      position: relative;
      color: var(--color-text-secondary);
    }

    .constraints-list li::before,
    .tech-stack-list li::before,
    .learnings-list li::before {
      content: "→";
      position: absolute;
      left: 0;
      color: var(--color-accent);
    }

    .decisions-list {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .decision-item {
      padding: 1.5rem;
      border: 1px solid rgba(201, 132, 116, 0.3);
      border-left: 3px solid var(--color-accent);
      border-radius: 0 8px 8px 0;
      background: rgba(201, 132, 116, 0.05);
    }

    .decision-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: var(--color-accent);
    }

    .decision-reasoning,
    .decision-alternatives {
      margin-top: 1rem;
    }

    .decision-reasoning strong,
    .decision-alternatives strong {
      display: block;
      font-size: 0.9375rem;
      color: var(--color-text-muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .decision-reasoning p {
      font-size: 1.0625rem;
      margin-top: 0.5rem;
      color: var(--color-text-secondary);
    }

    .decision-alternatives ul {
      list-style: none;
      padding: 0;
      margin-top: 0.5rem;
    }

    .decision-alternatives li {
      font-size: 1.0625rem;
      line-height: 1.6;
      padding: 0.25rem 0;
      padding-left: 1.25rem;
      position: relative;
      color: var(--color-text-secondary);
    }

    .decision-alternatives li::before {
      content: "•";
      position: absolute;
      left: 0;
      color: var(--color-accent);
    }

    .impact-qualitative {
      font-size: 1.125rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    .case-study-content {
      margin-top: 3rem;
      font-size: 1.0625rem;
      line-height: 1.7;
      color: var(--color-text-secondary);
    }

    /* MDX Content Styles */
    .case-study-content :global(h2) {
      font-size: 1.75rem;
      margin-top: 2.5rem;
      margin-bottom: 1rem;
      font-weight: 700;
      letter-spacing: -0.01em;
      line-height: 1.3;
      color: var(--color-text);
    }

    .case-study-content :global(h3) {
      font-size: 1.375rem;
      margin-top: 2rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      color: var(--color-text);
    }

    .case-study-content :global(p) {
      margin-bottom: 1.5rem;
      color: var(--color-text-secondary);
    }

    .case-study-content :global(ul),
    .case-study-content :global(ol) {
      margin-bottom: 1.5rem;
      padding-left: 1.5rem;
      color: var(--color-text-secondary);
    }

    .case-study-content :global(li) {
      margin-bottom: 0.5rem;
      line-height: 1.7;
    }

    .case-study-content :global(strong) {
      color: var(--color-text);
      font-weight: 600;
    }

    .case-study-content :global(hr) {
      margin: 3rem 0;
      border: none;
      border-top: 1px solid var(--color-border);
    }

    .case-study-content :global(a) {
      color: var(--color-accent);
      text-decoration: underline;
    }

    .case-study-content :global(a:hover) {
      color: var(--color-accent-hover);
    }

    /* Table styles with terracotta accents */
    .case-study-content :global(table) {
      width: 100%;
      margin: 2rem 0;
      border-collapse: collapse;
      font-size: 0.9375rem;
    }

    .case-study-content :global(thead) {
      border-bottom: 2px solid var(--color-accent);
    }

    .case-study-content :global(th) {
      padding: 0.875rem 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--color-text);
      background: rgba(201, 132, 116, 0.08);
    }

    .case-study-content :global(td) {
      padding: 0.875rem 1rem;
      color: var(--color-text-secondary);
      border-bottom: 1px solid var(--color-border);
    }

    .case-study-content :global(tr:hover td) {
      background: rgba(201, 132, 116, 0.04);
    }

    .case-study-content :global(th:first-child),
    .case-study-content :global(td:first-child) {
      border-left: 3px solid var(--color-accent);
      padding-left: 1rem;
    }

    /* Key Insight callout styles */
    .case-study-content :global(.key-insight) {
      margin: 1.5rem 0 2rem;
      padding: 1rem 1.25rem;
      background: rgba(201, 132, 116, 0.08);
      border-left: 3px solid var(--color-accent);
      border-radius: 0 6px 6px 0;
      font-size: 0.9375rem;
      line-height: 1.6;
    }

    .case-study-content :global(.key-insight strong) {
      color: var(--color-accent);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.75rem;
      letter-spacing: 0.05em;
      display: block;
      margin-bottom: 0.25rem;
    }

    /* Demo link button styles */
    .case-study-content :global(.demo-link) {
      display: inline-block;
      padding: 0.875rem 1.5rem;
      background: rgba(201, 132, 116, 0.1);
      border: 1px solid var(--color-accent);
      border-radius: 6px;
      color: var(--color-accent);
      font-weight: 600;
      font-size: 0.9375rem;
      text-decoration: none;
      transition: all 0.2s ease;
      margin: 1rem 0;
    }

    .case-study-content :global(.demo-link:hover) {
      background: rgba(201, 132, 116, 0.2);
      transform: translateY(-2px);
      text-decoration: none;
    }

    /* Decision cards in MDX content */
    .case-study-content :global(.decision-card) {
      padding: 1.5rem;
      margin: 1.5rem 0;
      border: 1px solid rgba(201, 132, 116, 0.3);
      border-left: 3px solid var(--color-accent);
      border-radius: 0 8px 8px 0;
      background: rgba(201, 132, 116, 0.05);
    }

    .case-study-content :global(.decision-card h3) {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 0 0 0.75rem 0;
      color: var(--color-accent);
    }

    .case-study-content :global(.decision-card p) {
      margin: 0;
      font-size: 1rem;
      line-height: 1.6;
    }

    /* Code blocks */
    .case-study-content :global(code) {
      font-family: ui-monospace, 'JetBrains Mono', 'Cascadia Code', Menlo, Consolas, 'Courier New', monospace;
      font-size: 0.9em;
      background: var(--color-bg-secondary);
      padding: 0.2em 0.4em;
      border-radius: 3px;
      color: var(--color-text);
    }

    .case-study-content :global(pre) {
      margin: 2rem 0;
      padding: 1.5rem;
      background: var(--color-bg-secondary);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      overflow-x: auto;
    }

    .case-study-content :global(pre code) {
      background: none;
      padding: 0;
      font-size: 0.875rem;
      line-height: 1.6;
    }

    @media (max-width: 768px) {
      .case-study {
        padding: 1.5rem 1rem;
      }

      .case-study-header h1 {
        font-size: 2rem;
      }

      .outcome-summary {
        font-size: 1.125rem;
      }

      .case-study-section h2 {
        font-size: 1.5rem;
      }

      .case-study-section p {
        font-size: 1rem;
      }

      .decision-item {
        padding: 1.25rem;
      }
    }
  </style>
</BaseLayout>
