---
/**
 * Note Detail Page
 *
 * Displays a single note with its content. Notes are shorter-form content
 * that highlight specific insights, with optional links back to related analysis.
 *
 * Route: /notes/[slug]
 *
 * @page
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import BackLink from '../../components/BackLink.astro';
import { getCollection, getEntry, render } from 'astro:content';
import { getReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const notes = await getCollection('notes', ({ data }) => {
    return data.draft === false;
  });
  return notes.map((note) => ({
    params: { slug: note.id },
  }));
}

const { slug } = Astro.params;
const note = await getEntry('notes', slug!);

if (!note) {
  return Astro.redirect('/404');
}

const { Content } = await render(note);
const { title, date, relatedAnalysis, relatedProject, tags } = note.data;

const readingTime = getReadingTime(note.body || '');

// Get related content if specified
let relatedArticle = null;
let relatedProjectEntry = null;
if (relatedAnalysis) {
  relatedArticle = await getEntry('analysis', relatedAnalysis);
}
if (relatedProject) {
  relatedProjectEntry = await getEntry('projects', relatedProject);
}

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  }).format(date);
}
---

<BaseLayout>
  <SEO
    slot="head"
    title={`${title} - Notes`}
    description={`A note on ${title.toLowerCase()}`}
    type="article"
    publishDate={date}
  />

  <main class="note">
    <header class="note-header">
      <h1>{title}</h1>
      <div class="note-meta">
        <time class="note-date" datetime={date.toISOString()}>
          {formatDate(date)}
        </time>
        <span class="meta-separator">Â·</span>
        <span class="reading-time">{readingTime}</span>
      </div>
      {tags && tags.length > 0 && (
        <div class="note-tags">
          {tags.map((tag) => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )}
    </header>

    <article class="note-content prose-content">
      <Content />
    </article>

    {relatedProjectEntry && (
      <div class="related-article">
        <span class="related-label">From the project</span>
        <a href={`/projects/${relatedProjectEntry.id}`} class="related-link">
          {relatedProjectEntry.data.title}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </div>
    )}

    {relatedArticle && (
      <div class="related-article">
        <span class="related-label">From the analysis</span>
        <a href={`/analysis/${relatedArticle.id}`} class="related-link">
          {relatedArticle.data.title}
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M5 12h14M12 5l7 7-7 7"/>
          </svg>
        </a>
      </div>
    )}

    <BackLink href="/notes" text="All notes" />
  </main>
</BaseLayout>

<style>
  .note {
    max-width: 680px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
  }

  .note-header {
    margin-bottom: 2.5rem;
    padding-bottom: 2rem;
    border-bottom: 1px solid var(--color-border);
  }

  .note-header h1 {
    font-size: 2rem;
    font-weight: 400;
    letter-spacing: -0.02em;
    line-height: 1.25;
    margin: 0 0 0.75rem 0;
  }

  .note-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
  }

  .meta-separator {
    opacity: 0.5;
  }

  .note-date {
    color: var(--color-text-secondary);
  }

  .note-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  .tag {
    font-size: 0.8125rem;
    padding: 0.25rem 0.75rem;
    background: rgba(74, 153, 97, 0.1);
    border: 1px solid var(--color-accent-secondary);
    border-radius: 4px;
    color: var(--color-accent-secondary);
  }

  /* Note-specific content overrides if needed */
  .note-content {
    /* Uses .prose-content from global.css */
  }

  .related-article {
    margin-top: 3rem;
    padding: 1.25rem;
    background: rgba(201, 132, 116, 0.08);
    border: 1px solid rgba(201, 132, 116, 0.2);
    border-radius: 8px;
  }

  .related-label {
    display: block;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin-bottom: 0.5rem;
  }

  .related-link {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 1rem;
    font-weight: 500;
    color: var(--color-accent);
    text-decoration: none;
    transition: gap 0.2s ease;
  }

  .related-link:hover {
    gap: 0.75rem;
  }

  .related-link svg {
    flex-shrink: 0;
  }

  @media (max-width: 768px) {
    .note {
      padding: 1.5rem 1rem 3rem;
    }

    .note-header h1 {
      font-size: 1.625rem;
    }

    .note-meta {
      font-size: 0.875rem;
    }

    .note-content {
      font-size: 1rem;
    }
  }
</style>
