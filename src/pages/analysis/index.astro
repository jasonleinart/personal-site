---
/**
 * Analysis Index Page
 *
 * Full-width listing of all published analysis articles with:
 * - 1100px max-width (matching homepage)
 * - Client-side tag filtering
 * - Two view modes: Grid (2-col cards) and List (dense rows)
 * - Featured article (set via frontmatter) gets full-width prominence
 *
 * Route: /analysis
 *
 * @page
 */

import BaseLayout from '../../layouts/BaseLayout.astro';
import SEO from '../../components/SEO.astro';
import { getCollection } from 'astro:content';
import { getReadingTime } from '../../utils/readingTime';
import { pagesConfig } from '../../pages.config';

// Get published articles only
const allArticles = await getCollection('analysis', ({ data }) => data.draft === false);
const sortedArticles = allArticles.sort((a, b) => {
  return b.data.publishDate.getTime() - a.data.publishDate.getTime();
});

// Separate featured article from the rest
const featuredArticle = sortedArticles.find(a => a.data.featured === true);
const remainingArticles = sortedArticles.filter(a => a !== featuredArticle);

// Extract unique tags from published articles only
const allTags = [...new Set(sortedArticles.flatMap(a => a.data.tags || []))].sort();

function formatDate(date: Date): string {
  return new Intl.DateTimeFormat('en-US', {
    month: 'short',
    day: 'numeric',
    year: 'numeric'
  }).format(date);
}
---

<BaseLayout>
  <SEO
    slot="head"
    title={pagesConfig.analysis.title}
    description={pagesConfig.analysis.description}
    type="website"
  />

  <main class="page-container">
    <header class="page-header">
      <div class="header-content">
        <h1 class="page-title">{pagesConfig.analysis.heading}</h1>
        <p class="page-intro">
          {pagesConfig.analysis.intro}
        </p>
      </div>
      <div class="header-meta">
        <span class="article-count" id="article-count">{sortedArticles.length} articles</span>
        <div class="view-toggle" role="group" aria-label="View mode">
          <button class="view-btn active" data-view="grid" aria-pressed="true">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="1" y="1" width="6" height="6" rx="1"/>
              <rect x="9" y="1" width="6" height="6" rx="1"/>
              <rect x="1" y="9" width="6" height="6" rx="1"/>
              <rect x="9" y="9" width="6" height="6" rx="1"/>
            </svg>
            Grid
          </button>
          <button class="view-btn" data-view="list" aria-pressed="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
              <line x1="1" y1="3" x2="15" y2="3"/>
              <line x1="1" y1="8" x2="15" y2="8"/>
              <line x1="1" y1="13" x2="15" y2="13"/>
            </svg>
            List
          </button>
        </div>
      </div>
    </header>

    <!-- Tag Filter Bar -->
    <div class="filter-bar">
      <button class="filter-tag active" data-tag="all">All</button>
      {allTags.map(tag => (
        <button class="filter-tag" data-tag={tag}>{tag}</button>
      ))}
    </div>

    <!-- Grid View -->
    <div class="articles-grid view-active" id="grid-view">
      {/* Featured article - full width */}
      {featuredArticle && (() => {
        const readTime = getReadingTime(featuredArticle.body || '');
        const tags = featuredArticle.data.tags || [];
        return (
          <a
            href={`/analysis/${featuredArticle.id}`}
            class="article-card featured"
            data-tags={tags.join(',')}
          >
            <div class="card-upper">
              <span class="card-meta">
                Featured · {formatDate(featuredArticle.data.publishDate)} · {readTime}
              </span>
              <h2 class="card-title">{featuredArticle.data.title}</h2>
              {featuredArticle.data.subtitle && (
                <p class="card-subtitle">{featuredArticle.data.subtitle}</p>
              )}
              <p class="card-description">{featuredArticle.data.description}</p>
            </div>
            <div class="card-lower">
              {tags.length > 0 && (
                <div class="card-tags">
                  {tags.map(tag => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
              )}
              <span class="read-link">Read article →</span>
            </div>
          </a>
        );
      })()}

      {/* Remaining articles - 2-column grid */}
      {remainingArticles.map((article) => {
        const readTime = getReadingTime(article.body || '');
        const tags = article.data.tags || [];
        return (
          <a
            href={`/analysis/${article.id}`}
            class="article-card"
            data-tags={tags.join(',')}
          >
            <div class="card-upper">
              <span class="card-meta">
                {formatDate(article.data.publishDate)} · {readTime}
              </span>
              <h2 class="card-title">{article.data.title}</h2>
              {article.data.subtitle && (
                <p class="card-subtitle">{article.data.subtitle}</p>
              )}
              <p class="card-description">{article.data.description}</p>
            </div>
            <div class="card-lower">
              {tags.length > 0 && (
                <div class="card-tags">
                  {tags.map(tag => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
              )}
              <span class="read-link">Read article →</span>
            </div>
          </a>
        );
      })}
    </div>

    <!-- List View -->
    <div class="articles-list" id="list-view">
      <div class="list-header">
        <span class="list-col-date">Date</span>
        <span class="list-col-title">Title</span>
        <span class="list-col-tags">Tags</span>
        <span class="list-col-time">Read</span>
      </div>
      {/* Featured article listed first, then remaining */}
      {[...(featuredArticle ? [featuredArticle] : []), ...remainingArticles].map((article) => {
        const readTime = getReadingTime(article.body || '');
        const tags = article.data.tags || [];
        return (
          <a
            href={`/analysis/${article.id}`}
            class="list-row"
            data-tags={tags.join(',')}
          >
            <span class="list-col-date">
              {formatDate(article.data.publishDate)}
            </span>
            <span class="list-col-title">
              <span class="list-title">{article.data.title}</span>
              <span class="list-description">{article.data.description}</span>
            </span>
            <span class="list-col-tags">
              {tags.map(tag => (
                <span class="tag-sm">{tag}</span>
              ))}
            </span>
            <span class="list-col-time">{readTime}</span>
          </a>
        );
      })}
    </div>

    <p class="empty-state" id="empty-state" style="display: none;">
      No articles match the selected filter.
    </p>
  </main>
</BaseLayout>

<script>
  // View Toggle
  const gridView = document.getElementById('grid-view')!;
  const listView = document.getElementById('list-view')!;
  const viewBtns = document.querySelectorAll('.view-btn');

  viewBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const view = btn.getAttribute('data-view');
      viewBtns.forEach(b => {
        b.classList.remove('active');
        b.setAttribute('aria-pressed', 'false');
      });
      btn.classList.add('active');
      btn.setAttribute('aria-pressed', 'true');

      if (view === 'grid') {
        gridView.classList.add('view-active');
        listView.classList.remove('view-active');
      } else {
        gridView.classList.remove('view-active');
        listView.classList.add('view-active');
      }
    });
  });

  // Tag Filtering
  const filterBtns = document.querySelectorAll('.filter-tag');
  const gridCards = gridView.querySelectorAll('.article-card');
  const listRows = listView.querySelectorAll('.list-row');
  const articleCount = document.getElementById('article-count')!;
  const emptyState = document.getElementById('empty-state')!;

  filterBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const tag = btn.getAttribute('data-tag');

      filterBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      let visibleCount = 0;

      const filterItems = (items: NodeListOf<Element>) => {
        items.forEach(item => {
          const itemTags = (item.getAttribute('data-tags') || '').split(',');
          const show = tag === 'all' || itemTags.includes(tag!);
          (item as HTMLElement).style.display = show ? '' : 'none';
          if (show) visibleCount++;
        });
      };

      visibleCount = 0;
      filterItems(gridCards);
      filterItems(listRows);

      // Divide by 2 since we count both grid and list items
      const actualCount = visibleCount / 2;
      articleCount.textContent = `${actualCount} article${actualCount !== 1 ? 's' : ''}`;
      emptyState.style.display = actualCount === 0 ? '' : 'none';
    });
  });
</script>

<style>
  .page-container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
    background-color: var(--color-bg);
  }

  /* Header */
  .page-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1.5rem;
    gap: 2rem;
  }

  .page-title {
    font-size: 2.5rem;
    font-weight: 400;
    margin-bottom: 0.75rem;
    letter-spacing: -0.02em;
  }

  .page-intro {
    font-size: 1.0625rem;
    color: var(--color-text-secondary);
    line-height: 1.6;
    max-width: 550px;
  }

  .header-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.75rem;
    flex-shrink: 0;
    padding-top: 0.5rem;
  }

  .article-count {
    font-size: 0.875rem;
    color: var(--color-text-muted);
  }

  /* View Toggle */
  .view-toggle {
    display: flex;
    gap: 0;
    border: 1px solid var(--color-border);
    border-radius: 6px;
    overflow: hidden;
  }

  .view-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.375rem 0.75rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-muted);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .view-btn:not(:last-child) {
    border-right: 1px solid var(--color-border);
  }

  .view-btn:hover {
    color: var(--color-text);
    background: var(--color-bg-secondary);
  }

  .view-btn.active {
    color: var(--color-accent);
    background: var(--color-accent-muted);
  }

  /* Filter Bar */
  .filter-bar {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--color-border);
  }

  .filter-tag {
    padding: 0.375rem 0.875rem;
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-text-secondary);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 100px;
    cursor: pointer;
    transition: all 0.15s ease;
    font-family: inherit;
  }

  .filter-tag:hover {
    border-color: var(--color-text-muted);
    color: var(--color-text);
  }

  .filter-tag.active {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background: var(--color-accent-muted);
  }

  /* Grid View */
  .articles-grid {
    display: none;
  }

  .articles-grid.view-active {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
  }

  .article-card {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    position: relative;
    padding: 1.5rem 1.75rem;
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: 8px;
    text-decoration: none;
    transition: border-color 0.2s ease, background 0.2s ease, transform 0.2s ease;
    overflow: hidden;
    min-height: 220px;
  }

  .article-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--gradient-accent);
    opacity: 0;
    transition: opacity 0.2s ease;
  }

  .article-card:hover {
    border-color: var(--color-text-muted);
    background: var(--color-bg-elevated);
    transform: translateY(-2px);
  }

  .article-card:hover::before {
    opacity: 1;
  }

  /* Featured card spans full width */
  .article-card.featured {
    grid-column: 1 / -1;
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 2rem;
    min-height: 200px;
    border-color: var(--color-border);
    background: var(--gradient-card);
  }

  .article-card.featured .card-title {
    font-size: 1.5rem;
  }

  .article-card.featured .card-lower {
    align-self: end;
    justify-self: end;
  }

  .card-upper {
    flex: 1;
  }

  .card-meta {
    display: block;
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
    margin-bottom: 0.625rem;
  }

  .card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: 0.5rem;
    line-height: 1.35;
    font-family: 'Instrument Serif', Georgia, serif;
  }

  .card-subtitle {
    font-size: 0.9375rem;
    color: var(--color-accent);
    font-style: italic;
    margin-bottom: 0.5rem;
    line-height: 1.4;
  }

  .card-description {
    font-size: 0.9375rem;
    color: var(--color-text-secondary);
    line-height: 1.55;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-lower {
    display: flex;
    justify-content: space-between;
    align-items: flex-end;
    margin-top: 1rem;
  }

  .card-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
  }

  .tag {
    padding: 0.1875rem 0.5rem;
    font-size: 0.6875rem;
    font-weight: 500;
    color: var(--color-accent-secondary);
    border: 1px solid rgba(74, 153, 97, 0.25);
    border-radius: 4px;
    background: rgba(74, 153, 97, 0.08);
  }

  .read-link {
    font-size: 0.8125rem;
    font-weight: 500;
    color: var(--color-accent);
    white-space: nowrap;
    flex-shrink: 0;
  }

  /* List View */
  .articles-list {
    display: none;
  }

  .articles-list.view-active {
    display: flex;
    flex-direction: column;
  }

  .list-header {
    display: grid;
    grid-template-columns: 140px 1fr 200px 80px;
    gap: 1rem;
    padding: 0.75rem 0;
    border-bottom: 2px solid var(--color-accent);
    font-size: 0.6875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--color-text-muted);
  }

  .list-row {
    display: grid;
    grid-template-columns: 140px 1fr 200px 80px;
    gap: 1rem;
    padding: 1rem 0;
    border-bottom: 1px solid var(--color-border);
    text-decoration: none;
    transition: all 0.15s ease;
    align-items: start;
  }

  .list-row:hover {
    background: var(--gradient-card);
    margin-left: -1rem;
    margin-right: -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
  }

  .list-col-date {
    font-size: 0.875rem;
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .list-col-title {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .list-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--color-text);
    line-height: 1.35;
  }

  .list-row:hover .list-title {
    color: var(--color-accent);
  }

  .list-description {
    font-size: 0.8125rem;
    color: var(--color-text-secondary);
    line-height: 1.45;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .list-col-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
  }

  .tag-sm {
    padding: 0.125rem 0.375rem;
    font-size: 0.625rem;
    font-weight: 500;
    color: var(--color-accent-secondary);
    border: 1px solid rgba(74, 153, 97, 0.2);
    border-radius: 3px;
  }

  .list-col-time {
    font-size: 0.8125rem;
    color: var(--color-text-muted);
    text-align: right;
  }

  /* Empty State */
  .empty-state {
    color: var(--color-text-muted);
    font-style: italic;
    padding: 3rem 0;
    text-align: center;
  }

  /* Responsive */
  @media (max-width: 900px) {
    .articles-grid.view-active {
      grid-template-columns: 1fr;
    }

    .article-card.featured {
      grid-template-columns: 1fr;
    }

    .article-card.featured .card-lower {
      justify-self: start;
    }
  }

  @media (max-width: 768px) {
    .page-container {
      padding: 1.5rem 1rem 3rem;
    }

    .page-header {
      flex-direction: column;
      gap: 1rem;
    }

    .header-meta {
      flex-direction: row;
      align-items: center;
      width: 100%;
      justify-content: space-between;
    }

    .page-title {
      font-size: 2rem;
    }

    .filter-bar {
      gap: 0.375rem;
    }

    .filter-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
    }

    /* Hide list view on mobile, force grid */
    .list-header,
    .list-row {
      display: none;
    }

    .articles-list.view-active {
      display: none;
    }

    .articles-grid {
      display: grid !important;
      grid-template-columns: 1fr;
    }

    .article-card {
      min-height: auto;
    }
  }
</style>
